<template>
	<div class="result_box">
		<div class="result">
			<div class="main">
				<mheader class="header" :getTitleUrl="titleUrl">
				</mheader>
				<div class="content">
					<div class="cardBox">
						<img src="//yoo.qpic.cn/yoo_img/0/65f633f347031e238f8e616a58a180d4/0" alt="">
					</div>
					<div class="vatar_box">
						<img src="//yoo.qpic.cn/yoo_img/0/65de1118e8876dcce293afe37f1c15b6/0" alt="">
						<div class="user_vatar_box" :style="{'background-image':'url('+user_vatar+')'}">
							<!-- <img :src="user_vatar" alt=""> -->
						</div>
						<div class="grade">
							{{gradeData}}分
						</div>
						<div class="des" v-html="des">
						</div>
					</div>
					<div class="tip_box">
						<p>本测试仅供娱乐</p>
					</div>
					<div class="btn_box">
						<img @click="showImage" src="//yoo.qpic.cn/yoo_img/0/c9ffec292d13f0c0e8896ccd8985a141/0">
						<img @click="toDownload" src="//yoo.qpic.cn/yoo_img/0/a9e261b9e1346515362efdf8d8f6018b/0">
					</div>
				</div>
				<leftTree class="left_tree"></leftTree>
				<rightTree class="right_tree"></rightTree>
				<img class="bgCloud" src="../assets/images/bgCloud.png" alt="">
				<div class="logo">
					<img src="../assets/images/logo.png" alt="欢遇logo">
				</div>
			</div>
		</div>
		<!-- 下面是海报结构	 -->
		<div class="result posterCanvas" ref='posterCanvas'>
			<div class="main">
				<mheader class="header" :getTitleUrl="titleUrl">
				</mheader>
				<div class="content">
					<div class="cardBox">
						<img src="//yoo.qpic.cn/yoo_img/0/65f633f347031e238f8e616a58a180d4/0" alt="">
					</div>
					<div class="vatar_box">
						<img src="//yoo.qpic.cn/yoo_img/0/65de1118e8876dcce293afe37f1c15b6/0" alt="">
						<div class="user_vatar_box" :style="{'background-image':'url('+user_vatar+')'}"> 
						</div> 
						<div class="grade">
							{{gradeData}}分
						</div>
						<div class="des" v-html="des">
						</div>
					</div>
					<div class="qr_box">
						<canvas ref="qrCanvas"></canvas>
					</div>
					<div class="tip">
						长按设别二维码<br>
						测测你的桃花运
					</div>
				</div>
				<leftTree class="left_tree"></leftTree>
				<rightTree class="right_tree"></rightTree>
				<img class="bgCloud" src="../assets/images/bgCloud.png" alt="">
				<div class="logo">
					<img src="../assets/images/logo.png" alt="欢遇logo">
					<p>视频相亲&nbsp;欢乐相遇</p>
				</div>
			</div>
		</div>
		<!-- 下面是展示海报用 -->
		<div class="poster" v-if="showPoster" @click.self="showPoster=false">
			<img :src="outPoster" alt="">
			<p @click.self="showPoster=false">长按保存图片分享</p>
		</div>
	</div>
</template>

<script>
	// @ is an alias to /src
	import mheader from "@/components/head.vue";
	import leftTree from "@/components/base/left_tree.vue";
	import rightTree from "@/components/base/right_tree.vue";
	import QRCode from "qrcode"; // 引入qrcode
	import html2canvas from 'html2canvas';
	import { mapState } from 'vuex';
	export default {
		components: {
			mheader,
			leftTree,
			rightTree
		},
		data(){
			return {
				user_vatar:'',
				des:null,
				showPoster:false,
				outPoster:''
			}
		}, 
		created(){
			// 获取本次游戏结果的描述:
			this.des = '如果<i>美貌有罪</i><br>你会被关到一百岁<br>如果追你要排队<br>我宁愿今晚不睡!'
			// window.console.log(window.user_avator_data)
			// 传入头像临时地址,读取blob并转化为base64,回调内将结果写入user_vatar
			this.blobToBase64(window.user_avator_data,(res)=>{
				this.user_vatar = res;
			})
		},
		mounted(){
			function getCookie(sKey) {
				return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[-.+*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
			};
			let type = this.$store.state.type;
			let result = this.$store.state.result;
			let uuid = getCookie('UUID');
			window.console.log(type,result,uuid)
			// 渲染二维码
			QRCode.toCanvas(
				this.$refs.qrCanvas,
				`http://www.baidu.com?type=${type}&uuid=${uuid}&result=${result}`,
				{ width: 115, height: 115 },
				(error)=>{
					if (error) window.console.error(error);
					window.console.log("qr success!");
					// 二维码生成后生成海报
					// html2canvas(this.$refs.posterCanvas,{
					// 	backgroundColor: null
					// }).then((canvas) => {
					// 	let dataURL = canvas.toDataURL("image/png");
					// 	window.console.log(6666);
					// 	this.outPoster = dataURL;
					// });
				}
			);
			
		},
		methods:{
			blobToBase64(blobUrl, callback) {
				//获取图片的Blob值
				this.$axios({
					url:blobUrl,
					responseType:"blob"
				}).then(res=>{
					let a = new FileReader();
					a.onload = function (e) { callback(e.target.result); }
					a.readAsDataURL(res.data);
				});
			},
			toDownload(){
				this.$router.push({name:"download"})
			},
			showImage() {
				window.console.log("海报!出现吧!")
				this.showPoster = true;
				window.console.log(this.showPoster);
				html2canvas(this.$refs.posterCanvas,{
					backgroundColor: null
				}).then((canvas) => {
					let dataURL = canvas.toDataURL("image/png");
					window.console.log(6666);
					this.outPoster = dataURL;
				});
			}
		},
		computed:{
			titleUrl(){
				return this.$store.state.gameData.scene_title.home_title_url;
			},
			...mapState({
                // 使用自定义变量名
                gradeData:(state)=>state.result.grade
            }),
		}
	}
</script>
<style lang="scss"> 
	@import '~@/assets/css/reset.css';
	@import '~@/assets/scss/util';
	#app{
		height: 100%;
		overflow: hidden;
	}
	.result_box{
		height:100%;
		position:relative;
		// 两个相似dom共用样式,海报在下面有修改
		.result{
			display: flex;
			height: 100%;
			width:100%;
			flex-direction: column;
			align-content: center;
			justify-content: center;
			background-repeat: no-repeat;
			background-image: url(../assets/images/bg.png);
			background-position: center;
			background-size:cover;
			position: absolute;
			top:0;
			left:0;
			z-index:9;
			.main{
				.header{
					z-index: 3;
				}
				.content{
					position: relative;
					margin-top: v(-200);
					z-index: 2;
					.cardBox{
						width: v(507);
						margin: 0 auto;
						>img{
							width: 100%;
						}
					}
					.vatar_box{
						width:v(260);
						position:absolute;
						top: v(30);
						left: 50%;
						transform: translateX(-50%);
						.grade{
							position:absolute;
							font-size: v(44);
							top: v(205);
							left: 50%;
							transform: translateX(-50%);
							color:#ffffff;
							font-weight: bold;
						}
						.des{
							margin-top: v(-20);
							text-align: center;
							font-size: v(30);
							color: #ffffff;
							line-height: v(63);
							i{
								color: #f87bd1;
								font-style:normal;
							}
						}
						>img{
							width: 100%;
							transform: translateX( v(-1) );
						}
						.user_vatar_box{
							width: v(152);
							height: v(152);
							position:absolute;
							top: v(43);
							overflow: hidden;
							border-radius: 50%;
							left:50%;
							background-color:skyblue;
							transform: translateX(-50%);
							background-size: cover ;
							background-position: center;
							background-repeat: no-repeat;
							img{
								width: 100%;
							}
						}
					}
					.tip_box{
						position: absolute;
						width:100%;
						top: v(610);
						text-align: center;
						font-size: v(24);
						color: #71416e;
					}
					
					.btn_box{
						width: v(500);
						margin: v(10) auto 0 auto;
						img{
							width : 100%;
						}
					}
				}
				.left_tree{
					position: absolute;
					left: 0;
					bottom: v(450);
					z-index:6;
				}
				.right_tree{
					position: absolute;
					right: 0;
					bottom: v(438);
					z-index:6;
				}
				.bgCloud{
					width: 100%;
					position: absolute;
					bottom: 0;
				}
				.logo{
					position: absolute;
					width: 100%;
					left: 0;
					bottom: v(10);
					text-align: center;
					>img{
						width: v(121);
						height: v(49);
					}
					
				}
			}
		}
		.posterCanvas{
			height:v(1200);
			z-index:3;
			.tip{
				color:white;
				margin-top: v(13);
				text-align: center;
				font-size: v(19);
				line-height: v(38);
			}
			.qr_box{
				text-align: center;
				margin: v(18) auto 0 auto;
				width: v(115);
				height: v(115);
				canvas{
					width: 100% !important;
					height: 100% !important;
				}
			}
			.main{
				.logo{
					position:absolute;
					left : v(24);
					bottom: v(48);
					color: #ffff;
					width: v(166) !important;
					font-size: 0;
					img{
						width: 100%;
						height: auto !important;
					}
					p{
						width:190%;
						font-size:v(16);
						letter-spacing: v(2);
						position:absolute;
						left: 50%;
						bottom: v(-30);
						transform:translate(-50%) scale(0.75);
					}
				}
			}
		}
		.poster{
			position:fixed;
			width:100vw;
			height:100vh;
			z-index:99;
			display:flex;
			justify-content:center;
			align-items: center;
			flex-wrap: wrap;
			flex-direction: column;
			background-color:rgba(0,0,0,0.32);
			img{
				width:92%;
				z-index:9;
			}
			p{
				z-index:9;
				position:absolute;
				bottom: v(40);
				text-align: center;
				color: white;
				width: 100%;
				margin-top: v(50);
			}
		}
	}
	
	
</style>
